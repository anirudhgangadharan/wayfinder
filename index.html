<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CareerConnect — Psychometric Prototype</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#6ee7b7; --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
    --maxw:960px; --radius:12px; --mono: "Segoe UI Mono", "Roboto Mono", monospace;
  }
  body{font-family:Inter,ui-sans-serif,system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:
    linear-gradient(180deg,#071024 0%, #08121b 100%); color:#e6eef6; margin:0; padding:40px; display:flex; justify-content:center;}
  .app{width:calc(100% - 40px); max-width:var(--maxw);}
  header{display:flex; gap:16px; align-items:center; margin-bottom:20px;}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#012;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg,var(--card), rgba(9,14,24,0.7)); padding:18px; border-radius:var(--radius); box-shadow: 0 8px 30px rgba(2,6,23,0.8); margin-bottom:16px;}
  .qtitle{font-weight:600;margin-bottom:8px}
  .question{margin-bottom:14px}
  .options{display:flex;flex-direction:column;gap:8px}
  button.opt{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:8px;color:var(--muted);text-align:left;cursor:pointer}
  button.opt.selected{background:linear-gradient(90deg, rgba(110,231,183,0.12), rgba(96,165,250,0.08)); color:var(--accent); border-color: rgba(110,231,183,0.12)}
  .controls{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;flex:1;margin-right:12px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%}
  .small{font-size:13px;color:var(--muted)}
  .result-grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
  .results{padding:12px; border-radius:10px; background:rgba(255,255,255,0.02)}
  .career-card{padding:12px;border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.02)}
  .bar{height:10px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;margin-top:8px}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%}
  .muted{color:var(--muted);font-size:13px}
  footer{margin-top:10px;text-align:center;color:var(--muted);font-size:13px}
  .top-actions{display:flex;gap:8px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#012;border:none}
  textarea{width:100%;height:120px;background:transparent;border:1px dashed rgba(255,255,255,0.03);color:var(--muted);padding:8px;border-radius:8px}
  .meta{font-size:12px;color:var(--muted)}
  @media (max-width:900px){ .result-grid{grid-template-columns:1fr} .logo{display:none} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">CC</div>
      <div>
        <h1>CareerConnect — Psychometric Prototype</h1>
        <p class="lead">22-question adaptive assessment (disguised scenarios + persona mosaic). Save / export results. No external services.</p>
      </div>
      <div style="margin-left:auto" class="top-actions">
        <button id="exportBtn" class="btn">Export JSON</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </header>

    <div id="main" class="card">
      <div id="questionWrap"></div>

      <div class="controls" style="margin-top:18px">
        <div class="progress"><i id="progressFill"></i></div>
        <div class="small" id="qCount">0 / 22</div>
      </div>
    </div>

    <div class="card result-grid" id="resultsArea" style="display:none">
      <div class="results" id="resultsLeft">
        <h3 style="margin-top:0">Persona Mosaic & Matches</h3>
        <div id="personaSummary" class="card" style="margin-bottom:12px"></div>
        <div id="careerMatches"></div>
      </div>
      <div class="card" id="resultsRight">
        <h4 style="margin-top:0">Confidence & Diagnostics</h4>
        <div id="confidenceBox" style="margin-bottom:12px"></div>
        <h4>Export / Share</h4>
        <div class="muted" style="margin-bottom:8px">Download results or copy JSON for APIs / mentor sharing.</div>
        <button id="downloadJson" class="btn primary" style="width:100%;margin-bottom:8px">Download JSON</button>
        <textarea id="jsonPreview" readonly></textarea>
      </div>
    </div>

    <footer class="muted">Prototype engine • V1 • Disguised, adaptive, culturally-aware scenarios • Runs locally</footer>
  </div>

<script>
/*
CareerConnect Prototype
- 22 questions (15 core + up to 7 branched)
- Each option contributes to a multi-dimensional user vector
- Vector dims: E, N, T, J, Enneagram[1..9], Archetypes[Sage,Explorer,Hero,Caregiver],
  Aptitudes[Logical,Verbal,Spatial,Interpersonal], Values[Money,Helping,Innovation,Stability]
- Scoring + cosine similarity against career vectors -> Career Resonance Score
- Confidence penalties applied for inconsistency/extreme bias
- Save/export JSON
*/

// ---------- Questions data (22) ----------
// Each question: {id, text, type, options: [{key,text,contrib}], branchIf: function(userAnswers) -> bool}
const QUESTIONS = [
  // Energy & Interaction 1-5
  {id:1, text:"You're organizing a class trip to a historical site like the Taj Mahal. What excites you most?", type:"mc",
    options:[
      {k:"A",t:"Chatting and making new friends along the way (social)", contrib:{E:2, Interpersonal:1}},
      {k:"B",t:"Quietly observing details and imagining stories (reflective)", contrib:{E:-1, N:1, Sage:0.5}},
      {k:"C",t:"Sticking to schedule and practical arrangements (practical)", contrib:{J:1, S:1, Stability:0.5}},
      {k:"D",t:"Brainstorming fun twists like a treasure hunt (inventive)", contrib:{N:2, Explorer:1}}
    ]},
  {id:2, text:"After a tough exam week, how do you unwind?", type:"mc",
    options:[
      {k:"A",t:"Hang out with friends at a café or park", contrib:{E:2, Interpersonal:1}},
      {k:"B",t:"Read a book or browse interesting facts online alone", contrib:{E:-1, N:1}},
      {k:"C",t:"Organize your room or play a familiar game", contrib:{J:1, Stability:0.6}},
      {k:"D",t:"Daydream about future adventures or inventions", contrib:{N:1, Explorer:0.6}}
    ]},
  {id:3, text:"In a group science project, your team is arguing about ideas. What do you do?", type:"mc",
    options:[
      {k:"A",t:"Jump in to mediate and get everyone excited", contrib:{E:1, Interpersonal:1, Hero:0.4}},
      {k:"B",t:"Step back, think deeply, then suggest a logical fix", contrib:{E:-1, T:1, Logical:1}},
      {k:"C",t:"Focus on what's worked before from textbooks", contrib:{S:1, J:0.6}},
      {k:"D",t:"Propose a wild new experiment no one's tried", contrib:{N:1.5, Explorer:0.8}}
    ], branchIf:(answers)=>{ return mixedEI(answers); }}, // branch if mixed E/I
  {id:4, text:"During Diwali, how do you help at home?", type:"mc",
    options:[
      {k:"A",t:"Decorate with family and invite neighbors over", contrib:{E:1, S:0.6, Interpersonal:0.6}},
      {k:"B",t:"Design unique rangoli patterns from imagination", contrib:{N:1, Sage:0.3}},
      {k:"C",t:"Plan the shopping list meticulously", contrib:{J:1, Stability:0.5}},
      {k:"D",t:"Reflect on what the festival means personally", contrib:{E:-1, Sage:0.8}}
    ]},
  {id:5, text:"You want to try a new hobby. Which appeals most?", type:"mc",
    options:[
      {k:"A",t:"Joining a sports team or dance group", contrib:{E:1.5, Interpersonal:1, Physical:0.5}},
      {k:"B",t:"Learning coding or puzzles online", contrib:{N:1.2, Logical:1}},
      {k:"C",t:"Collecting stamps or building models", contrib:{S:1, Spatial:1}},
      {k:"D",t:"Writing stories or drawing comics", contrib:{N:1, Verbal:1, Sage:0.4}}
    ]},

  // Decision & Harmony 6-10
  {id:6, text:"Your friend is upset about bad grades. How do you respond?", type:"mc",
    options:[
      {k:"A",t:"Give practical advice on study tips", contrib:{T:1, En1:1}},
      {k:"B",t:"Listen empathetically and share a similar story", contrib:{F:1, Interpersonal:1, En9:1}},
      {k:"C",t:"Motivate them to aim higher next time", contrib:{En3:1, Hero:0.6}},
      {k:"D",t:"Analyze why it happened and plan prevention", contrib:{T:1, En6:1}}
    ]},
  {id:7, text:"You find a lost wallet at the school fair. What do you do?", type:"mc",
    options:[
      {k:"A",t:"Return it immediately — it's the right thing", contrib:{En1:1, Agreeableness:1}},
      {k:"B",t:"Keep it if no one's around — finders keepers", contrib:{RiskTolerance:1}},
      {k:"C",t:"Ask friends what to do, to avoid trouble", contrib:{En6:1, SocialConformity:1}},
      {k:"D",t:"Use it to help someone in need anonymously", contrib:{F:1, En2:1}}
    ]},
  {id:8, text:"Winning a debate — what matters most to you? (1 = Prove logic, 10 = Make everyone feel heard)", type:"slider", min:1, max:10,
    options:[]},
  {id:9, text:"When facing a big failure, you feel...", type:"mc",
    options:[
      {k:"A",t:"Motivated to practice harder", contrib:{En3:1}},
      {k:"B",t:"Worried about what others think", contrib:{En6:1, SocialAnxiety:0.5}},
      {k:"C",t:"Reflective, learning for personal growth", contrib:{En4:1, Sage:0.6}},
      {k:"D",t:"Detached, it's just one event", contrib:{En5:1, Logical:0.4}}
    ], branchIf:(answers)=>{ return fearPattern(answers); }},
  {id:10, text:"In a community cleanup drive, your role is...", type:"mc",
    options:[
      {k:"A",t:"Leading the team with energy", contrib:{E:1.2, En8:1}},
      {k:"B",t:"Researching eco-friendly methods quietly", contrib:{En5:1, Logical:1}},
      {k:"C",t:"Ensuring everyone gets along", contrib:{F:1, En9:1}},
      {k:"D",t:"Innovating new ways to recycle", contrib:{N:1, En7:1}}
    ]},

  // Structure & Flow 11-14
  {id:11, text:"How do you handle your school timetable?", type:"mc",
    options:[
      {k:"A",t:"Follow it strictly for efficiency", contrib:{J:1, Conscientiousness:1}},
      {k:"B",t:"Adapt as needed, extra time for fun subjects", contrib:{P:1, Openness:1}},
      {k:"C",t:"Plan ahead but enjoy surprises", contrib:{J:0.5, P:0.5, Jester:0.6}},
      {k:"D",t:"Focus on big goals, details later", contrib:{P:1, Hero:0.4}}
    ]},
  {id:12, text:"A group assignment is due in a week. Your approach? (Rank: 1 Outline steps, 2 Gather ideas, 3 Delegate)", type:"rank",
    options:[ "Outline steps day-by-day", "Gather ideas freely", "Delegate tasks" ]},
  {id:13, text:"Which movie hero do you relate to most?", type:"mc",
    options:[
      {k:"A",t:"The wise teacher guiding others (Sage)", contrib:{Sage:1, En5:0.4}},
      {k:"B",t:"The bold explorer discovering new lands (Explorer)", contrib:{Explorer:1, RiskTolerance:0.6}},
      {k:"C",t:"The caregiver helping the village (Caregiver)", contrib:{Caregiver:1, En2:0.6}},
      {k:"D",t:"The ruler building a fair kingdom (Ruler)", contrib:{En1:0.6, Leadership:1}}
    ], branchIf:(answers)=>{ return true; }},
  {id:14, text:"If school changes the uniform rules suddenly, you...", type:"mc",
    options:[
      {k:"A",t:"Adjust quickly and see positives", contrib:{P:1, Adaptability:1}},
      {k:"B",t:"Prefer stability and question the change", contrib:{J:1, Stability:1}}
    ]},

  // Curiosity & Aptitude 15-18
  {id:15, text:"Which brain teaser do you enjoy?", type:"mc",
    options:[
      {k:"A",t:"Math riddles like number patterns", contrib:{Logical:1}},
      {k:"B",t:"Word games or stories", contrib:{Verbal:1}},
      {k:"C",t:"Building with blocks or drawing maps", contrib:{Spatial:1}},
      {k:"D",t:"Social dilemmas and negotiation scenarios", contrib:{Interpersonal:1}}
    ]},
  {id:16, text:"What school subject would you teach if you could?", type:"mc",
    options:[
      {k:"A",t:"Science experiments (STEM)", contrib:{Logical:1, N:0.6}},
      {k:"B",t:"History or literature (Humanities)", contrib:{Verbal:1, Sage:0.4}},
      {k:"C",t:"Business or economics (Commerce)", contrib:{Entrepreneurial:1}},
      {k:"D",t:"Art or music (Creative)", contrib:{Creative:1, N:0.8}}
    ]},
  {id:17, text:"On a scale 1-10: Imagining new inventions vs. fixing gadgets. (1 = fixer, 10 = inventor)", type:"slider", min:1, max:10},
  {id:18, text:"You're curious about...", type:"mc",
    options:[
      {k:"A",t:"How apps are coded (Tech)", contrib:{Logical:1, Explorer:0.4}},
      {k:"B",t:"Human body mysteries (Bio/Health)", contrib:{Interpersonal:0.6, Sage:0.4}},
      {k:"C",t:"Money and markets (Finance)", contrib:{Entrepreneurial:0.6}},
      {k:"D",t:"Stories and cultures (Communication)", contrib:{Verbal:1}}
    ], branchIf:(answers)=>{ return lowCuriosity(answers); }},

  // Values & Purpose 19-22
  {id:19, text:"What matters most in your future job?", type:"mc",
    options:[
      {k:"A",t:"Making a big impact on society (Hero)", contrib:{Hero:1, En8:0.6}},
      {k:"B",t:"Helping others feel supported (Caregiver)", contrib:{Caregiver:1, En2:0.8}},
      {k:"C",t:"Discovering new knowledge (Sage)", contrib:{Sage:1, En5:0.8}},
      {k:"D",t:"Achieving personal peace and balance", contrib:{En9:1, Stability:1}}
    ]},
  {id:20, text:"Would you start a small business with pocket money? (Yes/No + why)", type:"yesno"},
  {id:21, text:"Rank these values (drag order): Money, Helping People, Innovation, Stability", type:"rank",
    options:["Money","Helping People","Innovation","Stability"]},
  {id:22, text:"Looking back on a proud moment, it was because...", type:"mc",
    options:[
      {k:"A",t:"I achieved something tough (Achievement)", contrib:{En3:1}},
      {k:"B",t:"I connected deeply with someone", contrib:{F:1, En4:0.6}},
      {k:"C",t:"I solved a complex puzzle", contrib:{Logical:1, En5:0.6}},
      {k:"D",t:"I maintained harmony in a group", contrib:{En9:1, Interpersonal:0.6}}
    ]}
];

// ---------- Career database (prototype) ----------
// Each career vector aligns with our user vector dims set (normalized range roughly -1..1 or 0..1)
const CAREERS = [
  {id:"software_engineer", title:"Software Engineering (STEM)", desc:"Designing & building software systems.", vector: makeVector({N:0.8, T:0.7, Logical:0.9, Explorer:0.6, Innovation:0.7, Money:0.5})},
  {id:"data_scientist", title:"Data Science / ML Engineer", desc:"Modeling, analysis, research with data.", vector: makeVector({N:0.8, T:0.8, Logical:0.95, Sage:0.6, Innovation:0.6})},
  {id:"clinical_medicine", title:"Clinical Medicine / Healthcare", desc:"Patient-facing clinical roles and care.", vector: makeVector({F:0.7, Interpersonal:0.9, Caregiver:0.9, Stability:0.6})},
  {id:"product_manager", title:"Product Management / Biz", desc:"Product leadership between tech & users.", vector: makeVector({E:0.3, N:0.5, T:0.5, Leadership:0.8, Innovation:0.7, Money:0.6})},
  {id:"entrepreneur", title:"Entrepreneurship / Startups", desc:"Founding & scaling ventures.", vector: makeVector({Explorer:0.85, RiskTolerance:0.9, Innovation:0.9, Money:0.8, En8:0.6})},
  {id:"digital_media", title:"Digital Media & Creative", desc:"Design, content, storytelling roles.", vector: makeVector({N:0.7, Verbal:0.9, Creative:0.9, Sage:0.3})}
];

// ---------- Utilities & initial state ----------
let state = { answers: {}, order: [], presentedIds: [], currentIndex:0, personaVector: {}, scores: {}, meta:{} };

function makeVector(partials){
  // produce a full vector with all dims present; dims standardized
  const base = {
    E:0,N:0,T:0,J:0,
    En1:0,En2:0,En3:0,En4:0,En5:0,En6:0,En7:0,En8:0,En9:0,
    Sage:0,Explorer:0,Hero:0,Caregiver:0,
    Logical:0,Verbal:0,Spatial:0,Interpersonal:0,
    Money:0,Helping:0,Innovation:0,Stability:0,
    // extras
    RiskTolerance:0,Leadership:0,Conscientiousness:0,Openness:0
  };
  for (let k in partials) if (k in base) base[k] = partials[k];
  return base;
}

function clone(v){ return JSON.parse(JSON.stringify(v)); }

function zeroVector(){ return makeVector({}); }

// compute dot product
function dot(a,b){
  let s=0;
  for (let k in a) s += (a[k]||0)*(b[k]||0);
  return s;
}
function norm(a){ return Math.sqrt(dot(a,a)); }
function cosineSim(a,b){
  const na = norm(a), nb = norm(b);
  if(na===0 || nb===0) return 0;
  return dot(a,b)/(na*nb);
}

// ---------- Branching helpers ----------
// Mixed E/I: detect if user answered both extravert and introverted choices in first two Qs
function mixedEI(answers){
  const a1 = answers[1], a2 = answers[2];
  if(!a1 || !a2) return false;
  // consider choices that added E positive vs negative
  const eVals = [contribScoreForOption(1,a1,'E') || 0, contribScoreForOption(2,a2,'E') || 0];
  return (eVals[0] > 0 && eVals[1] < 0) || (eVals[0] < 0 && eVals[1] > 0);
}
function fearPattern(answers){
  // if Q6/Q7 show En6 or social worry -> branch
  const a6 = answers[6], a7 = answers[7];
  return (contribScoreForOption(6,a6,'En6')>0) || (contribScoreForOption(7,a7,'SocialConformity')>0);
}
function lowCuriosity(answers){
  // if Q15 selected not curious (not typical) — fallback to showing Q18
  const a15 = answers[15];
  if(!a15) return true;
  return false;
}

// ---------- Scoring helpers ----------
function mergeContribs(target, contrib){
  for (let k in contrib){
    if (!(k in target)) target[k] = 0;
    target[k] += contrib[k];
  }
}
function contribScoreForOption(qid, key, dim){
  const q = QUESTIONS.find(x=>x.id===qid);
  if(!q) return 0;
  if(q.type === 'mc'){
    const opt = q.options.find(o=>o.k===key);
    if(!opt) return 0;
    return (opt.contrib && (opt.contrib[dim]||0)) || 0;
  } else if (q.type === 'slider' || q.type==='rank' || q.type==='yesno'){
    // these are handled separately
    return 0;
  }
  return 0;
}

// ---------- Rendering ----------

const questionWrap = document.getElementById('questionWrap');
const progressFill = document.getElementById('progressFill');
const qCount = document.getElementById('qCount');
const resultsArea = document.getElementById('resultsArea');
const personaSummary = document.getElementById('personaSummary');
const careerMatches = document.getElementById('careerMatches');
const confidenceBox = document.getElementById('confidenceBox');
const jsonPreview = document.getElementById('jsonPreview');
const downloadJson = document.getElementById('downloadJson');

document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('exportBtn').addEventListener('click', showExport);

downloadJson.addEventListener('click', ()=> {
  const blob = new Blob([jsonPreview.value], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'careerconnect_result.json'; a.click();
  URL.revokeObjectURL(url);
});

// initialize order: we'll use core first then allow branching insertions
function initOrder(){
  state.order = [];
  const coreIds = QUESTIONS.map(q=>q.id);
  // We'll produce a sequence but allow skipping when branch false. Keep original order.
  state.order = coreIds;
}
initOrder();
renderCurrent();

function renderCurrent(){
  const idx = state.currentIndex;
  const total = QUESTIONS.length;
  // seek next question that passes branchIf if present
  let i = idx;
  while (i < state.order.length){
    const qid = state.order[i];
    const q = QUESTIONS.find(x=>x.id===qid);
    if(q.branchIf && typeof q.branchIf === 'function'){
      if(!q.branchIf(state.answers)){
        i++; continue;
      }
    }
    break;
  }
  if(i >= state.order.length){
    finishAssessment();
    return;
  }
  state.currentIndex = i;
  const qid = state.order[i];
  const q = QUESTIONS.find(x=>x.id===qid);
  renderQuestion(q, i+1, total);
  updateProgress(i+1, total);
}

function renderQuestion(q, number, total){
  qCount.textContent = `${number} / ${total}`;
  questionWrap.innerHTML = '';
  const container = document.createElement('div');
  container.className = 'question';

  const title = document.createElement('div');
  title.className = 'qtitle';
  title.textContent = `Q${q.id}. ${q.text}`;
  container.appendChild(title);

  if(q.type === 'mc'){
    const opts = document.createElement('div');
    opts.className = 'options';
    q.options.forEach(opt => {
      const b = document.createElement('button');
      b.className = 'opt';
      b.innerHTML = `<div style="font-weight:600">${opt.k}</div><div class="muted" style="font-size:13px">${opt.t}</div>`;
      b.addEventListener('click', ()=> { selectOption(q.id,opt.k); b.classList.add('selected'); });
      // restore selected state if previously answered
      if(state.answers[q.id] && state.answers[q.id].selected === opt.k) b.classList.add('selected');
      opts.appendChild(b);
    });
    container.appendChild(opts);
  } else if (q.type === 'slider'){
    const wrap = document.createElement('div');
    const range = document.createElement('input');
    range.type = 'range'; range.min = q.min||1; range.max = q.max||10; range.value = Math.round((q.min+q.max)/2);
    range.style.width='100%';
    const value = document.createElement('div'); value.className='muted'; value.textContent = range.value;
    range.addEventListener('input', ()=> value.textContent = range.value);
    const submit = document.createElement('button'); submit.className='btn primary'; submit.style.marginTop='8px'; submit.textContent='Save';
    submit.addEventListener('click', ()=> { state.answers[q.id] = {selected:range.value}; nextQuestion(); });
    wrap.appendChild(range); wrap.appendChild(value); wrap.appendChild(submit);
    container.appendChild(wrap);
  } else if (q.type === 'rank'){
    // simple UI: present items, allow user to order by clicking to move up/down — for brevity we'll use selects
    const wrap = document.createElement('div');
    q.options.forEach((opt, idx)=> {
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='8px';
      const label = document.createElement('div'); label.textContent = `${idx+1}.`; label.style.width='24px';
      const sel = document.createElement('select'); sel.style.flex='1';
      q.options.forEach(o=> {
        const op = document.createElement('option'); op.value=o; op.textContent=o;
        sel.appendChild(op);
      });
      sel.value = q.options[idx];
      row.appendChild(label); row.appendChild(sel); wrap.appendChild(row);
    });
    const submit = document.createElement('button'); submit.className='btn primary'; submit.textContent='Save'; submit.style.marginTop='8px';
    submit.addEventListener('click', ()=>{
      const selects = wrap.querySelectorAll('select'); const arr = [];
      selects.forEach(s=>arr.push(s.value));
      state.answers[q.id] = {selected:arr};
      nextQuestion();
    });
    container.appendChild(wrap); container.appendChild(submit);
  } else if (q.type === 'yesno'){
    const yes = document.createElement('button'); yes.className='btn'; yes.textContent='Yes';
    const no = document.createElement('button'); no.className='btn'; no.textContent='No';
    const area = document.createElement('div'); area.style.display='flex'; area.style.gap='8px';
    const reason = document.createElement('input'); reason.placeholder='Brief why (optional)'; reason.style.flex='1'; reason.style.padding='8px'; reason.style.background='transparent'; reason.style.border='1px solid rgba(255,255,255,0.03)'; reason.style.borderRadius='8px'; reason.style.color='var(--muted)';
    yes.addEventListener('click', ()=>{ state.answers[q.id] = {selected:'Yes', why:reason.value}; nextQuestion(); });
    no.addEventListener('click', ()=>{ state.answers[q.id] = {selected:'No', why:reason.value}; nextQuestion(); });
    area.appendChild(yes); area.appendChild(no); area.appendChild(reason);
    container.appendChild(area);
  }

  // skip/back controls
  const nav = document.createElement('div'); nav.style.display='flex'; nav.style.gap='8px'; nav.style.marginTop='12px';
  const skip = document.createElement('button'); skip.className='btn'; skip.textContent='Skip';
  const back = document.createElement('button'); back.className='btn'; back.textContent='Back';
  skip.addEventListener('click', ()=> { state.answers[q.id] = {selected:null, skipped:true}; nextQuestion();});
  back.addEventListener('click', ()=> { state.currentIndex = Math.max(0, state.currentIndex - 1); renderCurrent(); });
  nav.appendChild(back); nav.appendChild(skip);
  container.appendChild(nav);

  questionWrap.appendChild(container);
}

function selectOption(qid, key){
  // store answer with contrib snapshot
  const q = QUESTIONS.find(x=>x.id===qid);
  const opt = q.options.find(o=>o.k===key);
  state.answers[qid] = {selected:key, contrib: clone(opt.contrib)};
  nextQuestion();
}

function nextQuestion(){
  state.currentIndex = state.currentIndex + 1;
  renderCurrent();
}
function updateProgress(pos, total){
  const pct = Math.round((pos/total)*100);
  progressFill.style.width = pct + '%';
}

// ---------- After finishing ----------

function finishAssessment(){
  // Calculate persona vector
  state.presentedIds = state.order.slice(0, state.currentIndex);
  const v = zeroVector();
  // handle MC contribs
  QUESTIONS.forEach(q=>{
    const a = state.answers[q.id];
    if(!a) return;
    if(q.type === 'mc' && a.selected && a.contrib){
      mergeContribs(v, a.contrib);
    } else if (q.type === 'slider' && a.selected){
      // slider handling: map to dims heuristically
      if(q.id === 8){ // debate: slider towards 1 = T, 10 = F
        const val = Number(a.selected);
        mergeContribs(v, {T: (11-val)/10, F: (val-1)/10});
      } else if (q.id === 17){ // inventions vs fixer
        const val = Number(a.selected); // 1..10 -> N vs S
        mergeContribs(v, {N: (val-1)/9, S: (10-val)/9});
      }
    } else if (q.type === 'rank' && a.selected){
      // for rank questions, weigh by position
      if(q.id === 12){
        // Outline steps higher weight = J
        const arr = a.selected;
        arr.forEach((it,idx)=>{
          if(it.includes('Outline')) mergeContribs(v, {J: (3-idx)/3});
          if(it.includes('Gather')) mergeContribs(v, {P: (3-idx)/3});
          if(it.includes('Delegate')) mergeContribs(v, {Leadership: (3-idx)/3});
        });
      } else if (q.id === 21){
        const arr = a.selected;
        arr.forEach((it, idx)=> {
          const score = (4 - idx)/4;
          if(it === 'Money') mergeContribs(v, {Money:score});
          if(it === 'Helping People') mergeContribs(v, {Helping:score});
          if(it === 'Innovation') mergeContribs(v, {Innovation:score});
          if(it === 'Stability') mergeContribs(v, {Stability:score});
        });
      }
    } else if (q.type === 'yesno' && a.selected){
      if(q.id === 20){
        if(a.selected === 'Yes') mergeContribs(v, {RiskTolerance:0.8, Entrepreneurial:0.6});
        else mergeContribs(v, {RiskTolerance:0.2, Stability:0.6});
        if(a.why){
          // small natural-language parse heuristics
          if(a.why.toLowerCase().includes('learn')) mergeContribs(v,{Explorer:0.4});
        }
      }
    }
  });

  // Normalization: simple scaling to 0..1 / -1..1 where appropriate
  // For simplicity, we'll clamp and scale based on observed ranges
  Object.keys(v).forEach(k=>{
    // clamp
    if(v[k] > 3) v[k] = 3;
    if(v[k] < -3) v[k] = -3;
  });

  state.personaVector = v;

  // Consistency check: compute std dev across top personality axes (E,N,T,J)
  const coreAxes = ['E','N','T','J'];
  const vals = coreAxes.map(a=> Math.abs(v[a]||0) );
  const mean = vals.reduce((s,x)=>s+x,0)/vals.length;
  const sd = Math.sqrt(vals.reduce((s,x)=>s+Math.pow(x-mean,2),0)/vals.length);
  const inconsistencyPenalty = sd > 1 ? 15 : (sd > 0.6 ? 8 : 0);

  // Extreme bias penalty: if many dims at extremes (>2.4 or <-2.4) count
  let extremeCount = 0;
  Object.values(v).forEach(x => { if(Math.abs(x) > 2.4) extremeCount++; });
  const extremePenalty = extremeCount >= 4 ? 12 : (extremeCount >=2 ? 6 : 0);

  // Now compute career matches using cosine similarity on a reduced vector subset that matters
  const userVec = normalizeForMatching(v);
  const matches = CAREERS.map(c => {
    const s = cosineSim(userVec, normalizeForMatching(c.vector));
    return {...c, score: Math.round(s * 10000)/100}; // percent with 2 decimals
  }).sort((a,b)=>b.score - a.score);

  // Confidence level base
  let baseConfidence = 100 - inconsistencyPenalty - extremePenalty;
  if(baseConfidence < 20) baseConfidence = 20;
  if(baseConfidence > 98) baseConfidence = 98;

  // Apply penalty per career if user answered few questions covering required dims
  const answeredCount = Object.keys(state.answers).length;
  const coveragePenalty = answeredCount < 16 ? Math.round((16 - answeredCount) * 2) : 0;
  baseConfidence = Math.max(12, baseConfidence - coveragePenalty);

  // Build results
  state.scores = {matches, confidence: baseConfidence, inconsistencyPenalty, extremePenalty, answeredCount};

  renderResults();
  resultsArea.style.display = 'grid';
  // fill json preview
  jsonPreview.value = JSON.stringify(buildExportJSON(), null, 2);
}

function normalizeForMatching(v){
  // For career vector matching, focus on relevant dims and scale to positive space
  const dims = ['E','N','T','J','En1','En2','En3','En4','En5','En6','En7','En8','En9',
                'Sage','Explorer','Hero','Caregiver','Logical','Verbal','Spatial','Interpersonal',
                'Money','Helping','Innovation','Stability','RiskTolerance','Leadership'];
  const out = {};
  dims.forEach(d=>{
    let val = v[d]||0;
    // ensure values mapped to 0..1 roughly: shift negatives to lower end
    // Many dims were added small; apply a simple transformation
    val = (val + 3) / 6; // -3..3 -> 0..1
    if(val < 0) val = 0; if(val > 1) val = 1;
    out[d] = val;
  });
  return out;
}

function renderResults(){
  personaSummary.innerHTML = '';
  const v = state.personaVector;
  const topEn = topEnneagram(v);
  const topArch = topArchetypes(v);
  const mbti = deriveMBTI(v);

  const html = `
    <div style="display:flex;justify-content:space-between;gap:12px">
      <div>
        <div><strong>MBTI-like synthesis:</strong> ${mbti}</div>
        <div class="muted">Enneagram: ${topEn.name} (${topEn.score} pts)</div>
        <div class="muted">Archetype blend: ${topArch.summary}</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Questions answered</div>
        <div style="font-weight:700">${state.scores ? state.scores.answeredCount : Object.keys(state.answers).length}/22</div>
      </div>
    </div>
    <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0;">
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
      ${['E','N','T','J','Logical','Verbal','Spatial','Interpersonal'].map(d=>{
        const val = Math.round(((v[d]||0)+3)/6*100);
        return `<div class="muted" style="font-size:12px">${d}<div class="bar"><i style="width:${val}%"></i></div></div>`;
      }).join('')}
    </div>
  `;
  personaSummary.innerHTML = html;

  // careers
  careerMatches.innerHTML = '';
  const matches = state.scores.matches;
  // apply confidence per career (score * persona conf)
  matches.slice(0,6).forEach((m, idx)=>{
    const conf = Math.round(m.score * (state.scores.confidence/100)*100)/100;
    const c = document.createElement('div'); c.className = 'career-card';
    c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${m.title}</strong><div class="muted" style="font-size:13px">${m.desc}</div></div>
      <div style="text-align:right"><div style="font-weight:700">${conf}%</div><div class="muted">Resonance</div></div>
    </div>
    <div class="bar"><i style="width:${Math.min(conf,100)}%"></i></div>
    <div class="muted" style="margin-top:8px">Similarity: ${m.score}% • Vector match</div>`;
    careerMatches.appendChild(c);
  });

  confidenceBox.innerHTML = `
    <div><strong>Overall confidence:</strong> ${state.scores.confidence}%</div>
    <div class="muted">Inconsistency penalty: ${state.scores.inconsistencyPenalty}%</div>
    <div class="muted">Extreme bias penalty: ${state.scores.extremePenalty}%</div>
    <div style="margin-top:8px" class="muted">Explanation: Scores derive from cosine similarity between your Persona Mosaic and prototype career vectors. Confidence decreases when responses are inconsistent, answer coverage is low, or many extreme answers appear.</div>
  `;
}

// helper: find top Enneagram
function topEnneagram(v){
  const keys = ['En1','En2','En3','En4','En5','En6','En7','En8','En9'];
  let best = {name:'Unknown', score:0};
  keys.forEach((k,idx)=>{
    const s = Math.round((v[k]||0)*100)/100;
    if(s > best.score){ best = {name:`Type ${idx+1}`, score:s}; }
  });
  return best;
}
function topArchetypes(v){
  const arr = ['Sage','Explorer','Hero','Caregiver'].map(k=>({k, v:(v[k]||0)})).sort((a,b)=>b.v-a.v);
  const summary = arr.map(a=>`${a.k}:${Math.round(a.v*100)/100}`).join(' • ');
  return {summary, arr};
}
function deriveMBTI(v){
  const E = v.E || 0; const N = v.N || 0; const T = v.T || 0; const J = v.J || 0;
  const ch = (E>0? 'E':'I') + (N>0? 'N':'S') + (T>0? 'T':'F') + (J>0? 'J':'P');
  return ch;
}

function buildExportJSON(){
  return {
    timestamp: new Date().toISOString(),
    answers: state.answers,
    personaVector: state.personaVector,
    results: state.scores
  };
}

function showExport(){
  if(!state.scores || !state.personaVector) {
    alert('Complete the assessment first (answer all or many questions) to export results.');
    return;
  }
  jsonPreview.value = JSON.stringify(buildExportJSON(), null, 2);
  resultsArea.style.display = 'grid';
}

// reset
function resetAll(){
  if(!confirm('Reset all answers and restart?')) return;
  state = { answers: {}, order: [], presentedIds: [], currentIndex:0, personaVector: {}, scores: {}, meta:{} };
  initOrder();
  resultsArea.style.display = 'none';
  jsonPreview.value = '';
  renderCurrent();
}

// ---------- initial simple heuristics for branching dependencies ----------
// (Already referenced in QUESTIONS above via functions)

// ---------- end ----------
</script>
</body>
</html>
